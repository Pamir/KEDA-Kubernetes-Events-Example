# KEDA Sample for Kubernetes Events

This is an example of using [KEDA](https://github.com/kedacore/keda) with Kubernetes Events.

KEDA (Kubernetes-based Event Driven Autoscaling) allows you to auto scale your kubernetes pods based on external metrics derived from systems such as RabbitMQ, Azure Storage Queues, GCP PubSub, Azure ServiceBus, etc. It also lets your scale the number of pods to zero so that you're not consuming resources when there is no processing to be done.

# Prerequisites
You need a Kubernetes cluster with KEDA installed. The [KEDA git hub repository](https://github.com/kedacore/keda) explains how this can be done using Helm.

# Tutorial

KEDA allows you to scale automatically based on kubernetes events. So, if you have an application that is listening to kubernetes events and reacting to them you can scale that application up depending on the number of events being generated in kubernetes. You can also scale your pods down to zero if no events are being generated so that you are not wasting precious compute resources.

Scaling in KEDA works based on a Custom Resource Definition called ScaledObject. The scaled object defines which metrics you want to scale based on and also the deployment that you are trying to scale. A sample ScaledObject for Kubernetes events looks like the following

```yaml
apiVersion: keda.k8s.io/v1alpha1
kind: ScaledObject
metadata:
  name: kubernetes-events-scaledobject
  namespace: keda-kubernetes-events-scaler
  labels:
    deploymentName: keda-kubernetes-events-scaler-node
spec:
  scaleTargetRef:
    deploymentName: keda-kubernetes-events-scaler-node
  triggers:
  - type: kubernetes-events
    metadata:
      fieldSelector: "metadata.namespace=events-sample,type=Warning" # Optional
      scaleDownPeriodSeconds: "60"
      numberOfEvents: "3"
```

This scaled object scales the deployment named **keda-kubernetes-events-scaler-node**. The Trigger type depends on the event that you want to scale based on. In this case it is **kubernetes-events** however if you would like to scale based on other metrics such as number of items in a Redis list you can.

The **fieldSelector** in the ScaledObject lets you filter the events that you're interested in. So if you're only interested in events of **type=Warning** you can only scale based on those.

The **scaledDownPeriodSeconds** represents the amount of time the scaler will wait to see if there are any events before scaling down to zero. And the **numberOfEvents** field in the ScaledObject is used to determine the number of pods that be created depending on the number of events being generated by kubernetes. In this case if we have more that an averate of 3 events being processed in the last 60 seconds then we will scale up the number of pods.

In this example we will deploy an application that listens to kubernetes events. This is a go app that uses the client-go libarary. The application will be scaled based on a scaled object that we create.  

We will start by creating a namespace to host the application.

```sh
kubectl create ns keda-kubernetes-events-scaler 
```

We shall now deploy the application using the manifests in this repository.

```sh
kubectl apply -f manifests/
```

The manifests create a deployment for the application and also create a **scaled object** for that deployment. The manifests also create a service account, role and role binding. The service account is used by the app to access events in the **events-sample** namespace. We will be monitoring that namespace for events.

We will first need to create that namespace

```sh
kubectl create ns events-sample
```

Now, lets see if any pods have been created as a part of the deployment that we had created earlier.

```sh
kubectl get pods -n keda-kubernetes-events-scaler 
```

You should not see any pods running. The reason is that KEDA would have scaled down the pods to zero based on no events being generated in the **events-sample** namespace.

Now, lets deploy a pod in that namespace with a non-existent namespace so that the creation fails and events are generated

```sh
kubectl run test \
    -n keda-kubernetes-events-scaler \
    -restart=Never \
    --image=doesnotexist/doesnotexist
```

If you run the following command again. You should see some pods coming up:
```sh
kubectl get pods -n keda-kubernetes-events-scaler 
```

If you wait for long enough you should see the pods in the **keda-kubernetes-events-scaler** namespace scale down again.